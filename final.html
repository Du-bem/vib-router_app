<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple Map</title>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }

        #mapContainer {
            width: 700px;
            float: left;
            overflow: hidden;
            display: block;
        }

        #destinationHolder {
            width: 300px;
            float: left;
            padding: 10px;
        }

        #destinationHolder h3 {
            font-family: Arial, Helvetica, san-serif;
        }

        #destinationHolder input {
            width: 200px;
            border: solid 1px #CCC;
            padding: 0 5px;
            float: left;
            margin: 0 10px 0 0;
            line-height: 30px;
        }

        #destinationHolder button {
            line-height: 30px;
            border: none;
            background-color: #444;
            color: #FFFFFF;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="mapContainer">
        <div id="map"></div>
    </div>
    <div id="destinationHolder">
        <input type="text" id="destination_input" placeholder="Please put destination">
        <button id="submit">Go!</button>
        <br>
        <input type="text" id="person_position" placeholder="Please put the person coordinate">
        <button id="person_submit">Go!</button>
    </div>
    <button onclick="getLocation()">Try It</button>

    <p id="demo"></p>

    <script>
        const x = document.getElementById("demo");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function success(position) {
            x.innerHTML = "Latitude: " + position.coords.latitude +
                "<br>Longitude: " + position.coords.longitude;
        }

        function error() {
            alert("Sorry, no position available.");
        }
    </script>
    <script>
        var pos;
        var map, infoWindow;
        let waypoints = [];

        function updateUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                }, function() {
                    alert('current position issue');
                });
            } else {
                alert('Browser does not support Geolocation!');

                return false;
            }

            return true;
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 12
            });
            var directionsService = new google.maps.DirectionsService();
            var directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            if (updateUserLocation()) {
                console.log("put center");
                var originMarker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    animation: google.maps.Animation.DROP,
                    title: 'My current position!'
                });
                map.setCenter(pos);
                document.getElementById('submit').addEventListener('click', function () {
                    console.log('ok my location');
                    calculateAndDisplayRoute(pos, directionsService, directionsRenderer)
                });
            }

            // // Try HTML5 geolocation.
            // if (navigator.geolocation) {
            //     if (updateUserLocation()) {
            //         var originMarker = new google.maps.Marker({
            //             position: pos,
            //             map: map,
            //             animation: google.maps.Animation.DROP,
            //             title: 'My current position!'
            //         });
            //         map.setCenter(pos);
            //         document.getElementById('submit').addEventListener('click', function () {
            //             console.log('ok my location');
            //             calculateAndDisplayRoute(pos, directionsService, directionsRenderer)
            //         });
            //     }
            //     // navigator.geolocation.getCurrentPosition(function (position) {
            //     //     pos = {
            //     //         lat: position.coords.latitude,
            //     //         lng: position.coords.longitude
            //     //     };
            //     //     var originMarker = new google.maps.Marker({
            //     //         position: pos,
            //     //         map: map,
            //     //         animation: google.maps.Animation.DROP,
            //     //         title: 'My current position!'
            //     //     });
            //     //     map.setCenter(pos);
            //     //     document.getElementById('submit').addEventListener('click', function () {
            //     //         console.log('ok my location');
            //     //         calculateAndDisplayRoute(pos, directionsService, directionsRenderer)
            //     //     });
            //     // }, function () {
            //     //     console.log('current position issue');
            //     // });
            // } else {
            //     alert('Browser does not support Geolocation!');
            // }
        }

        function calculateAndDisplayRoute(origin, directionsService, directionsRenderer) {
            directionsService.route(
                {
                    origin: origin,
                    destination: { query: document.getElementById('destination_input').value },
                    travelMode: 'WALKING',
                    provideRouteAlternatives: true
                },
                function (response, status) {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                        for (const [key, value] of Object.entries(response["routes"][0]["overview_path"])) {
                            // console.log("{ lat: " + value.lat() + ", lng: " + value.lng() + "}");
                            waypoints.push({ lat: value.lat(), lng: value.lng() });
                        }
                    } else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });
        }

        // Function to calculate the bearing between two coordinates
        function calculateBearing(from, to) {
            const lat1 = from.lat * Math.PI / 180;
            const lon1 = from.lng * Math.PI / 180;
            const lat2 = to.lat * Math.PI / 180;
            const lon2 = to.lng * Math.PI / 180;

            const dLon = lon2 - lon1;

            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

            const initialBearing = Math.atan2(y, x);
            let degree = (initialBearing * 180 / Math.PI + 360) % 360; // Normalize to 0-360Â°

            return degree;
        }

        // Function to convert bearing to detailed direction
        function bearingToDirection(bearing) {
            console.log(bearing);
            if (bearing >= 0 && bearing < 22.5) {
                return "North";
            } else if (bearing >= 22.5 && bearing < 45) {
                return "North East";
            } else if (bearing >= 45 && bearing < 67.5) {
                return "East North";
            } else if (bearing >= 67.5 && bearing < 112.5) {
                return "East";
            } else if (bearing >= 112.5 && bearing < 157.5) {
                return "East South";
            } else if (bearing >= 157.5 && bearing < 202.5) {
                return "South";
            } else if (bearing >= 202.5 && bearing < 247.5) {
                return "South West";
            } else if (bearing >= 247.5 && bearing < 292.5) {
                return "West South";
            } else if (bearing >= 292.5 && bearing < 337.5) {
                return "West";
            } else {
                return "North West";
            }
        }

        // Function to get direction between two coordinates
        function getDirection(from, to) {
            const bearing = calculateBearing(from, to);
            return bearingToDirection(bearing);
        }

        // Function to check if the current position is close enough to the waypoint
        function isAtWaypoint(currentPosition, waypoint) {
            return Math.abs(currentPosition.lat - waypoint.lat) < 0.00003 && Math.abs(currentPosition.lng - waypoint.lng) < 0.00003;
        }

        // Function to get the next waypoint and direction
        function getNextWaypoint(currentPosition) {
            for (let i = 0; i < waypoints.length; i++) {
                if (isAtWaypoint(currentPosition, waypoints[i])) {
                    waypoints.splice(i, 1); // Remove the current waypoint from the array
                    return { nextWaypoint: waypoints[0], direction: waypoints.length > 0 ? getDirection(currentPosition, waypoints[0]) : 'You have reached your destination.' };
                }
            }
            return { nextWaypoint: waypoints[0], direction: waypoints.length > 0 ? getDirection(currentPosition, waypoints[0]) : 'You have no more waypoints.' };
        }

        // Function to manually send the person's location and get directions
        function getDirectionsForPerson(currentPosition) {
            console.log(waypoints);
            let result = getNextWaypoint(currentPosition);
            console.log(`Current Location: Lat ${currentPosition.lat}, Lng ${currentPosition.lng}`);
            console.log(`Next direction: ${result.direction}`);
            console.log(waypoints);
            return result.direction;
        }

        document.getElementById('person_submit').addEventListener('click', function () {
            // Test the function by passing in the person's current location (D)
            // let position = document.getElementById("person_position").value.split(",")
            // let personLocation = { lat: parseFloat(position[0]), lng: parseFloat(position[1]) };
            // console.log(personLocation);
            if (updateUserLocation()) {
                console.log(pos);
                getDirectionsForPerson(pos);
            }
        });
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZnlI-Sjte7_VUF4zS_7IUG5FBTMtzQZk&callback=initMap">
        </script>
</body>

</html>